# MagickCrop Code Coverage Guide

## Overview

This document explains how code coverage reporting is configured and used in the MagickCrop project.

## Coverage Configuration

### Setup

Code coverage is configured using **Coverlet** with **OpenCover** format for CI/CD compatibility.

**Configuration file**: `.runsettings`

```xml
<?xml version="1.0" encoding="utf-8"?>
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat code coverage">
        <Configuration>
          <Format>opencover</Format>
          <Exclude>[MagickCrop.Tests]*,[xunit*]*,[*.Tests]*</Exclude>
          <IncludeTestAssembly>false</IncludeTestAssembly>
          <Threshold>60</Threshold>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
```

## Running Coverage Reports

### Generate Coverage Report

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

This generates coverage data in `MagickCrop.Tests/TestResults/coverage.opencover.xml`

### View HTML Report

Install ReportGenerator:

```bash
dotnet tool install -g ReportGenerator
```

Generate HTML report:

```bash
reportgenerator "-reports:MagickCrop.Tests/TestResults/coverage.opencover.xml" "-targetdir:coverage-report"
```

Open `coverage-report/index.html` in browser.

## Coverage Targets

### By Component Type

| Component | Target | Rationale |
|-----------|--------|-----------|
| ViewModels | 80%+ | Core business logic |
| Services | 75%+ | Important infrastructure |
| Models | 65%+ | Data structures |
| Utilities | 60%+ | Helper methods |
| UI Code-Behind | 0%* | Not unit tested |

*UI code-behind is tested through integration tests and manual testing.

### Current Status

Run `dotnet test /p:CollectCoverage=true` to see current coverage metrics.

## Coverage in CI/CD

### GitHub Actions

Coverage reports are automatically generated on:
- Pull requests (blocks merge if coverage decreases >5%)
- Pushes to main branch

Reports are published to GitHub Pages.

### Local Development

Check coverage before committing:

```bash
# Run tests with coverage
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover

# Generate HTML report
reportgenerator "-reports:MagickCrop.Tests/TestResults/coverage.opencover.xml" "-targetdir:coverage-report"

# Open report
start coverage-report/index.html
```

## Improving Coverage

### Identify Untested Code

1. Generate HTML report (see above)
2. Look for red lines (not covered)
3. Find corresponding test file
4. Add test case for uncovered scenario

### Common Coverage Gaps

1. **Exception handling**: Add tests for error paths
2. **Edge cases**: Test boundary conditions
3. **Property setters**: Verify INotifyPropertyChanged
4. **Async operations**: Test async paths fully
5. **Command execution**: Test all command code paths

### Example: Adding Coverage

**Untested code in ImageProcessingService.cs**:
```csharp
public bool ValidateImageFormat(string filePath)
{
    if (string.IsNullOrEmpty(filePath))
        return false; // NOT TESTED
    
    var ext = Path.GetExtension(filePath).ToLower();
    return ext == ".jpg" || ext == ".png"; // PARTIALLY TESTED
}
```

**Add test**:
```csharp
[TestMethod]
public void ValidateImageFormat_WithNullPath_ReturnsFalse()
{
    var result = _service.ValidateImageFormat(null!);
    Assert.IsFalse(result);
}

[TestMethod]
[DataRow(".gif")]
[DataRow(".bmp")]
[DataRow(".tiff")]
public void ValidateImageFormat_WithUnsupportedFormat_ReturnsFalse(string format)
{
    var result = _service.ValidateImageFormat($"test{format}");
    Assert.IsFalse(result);
}
```

## Excluding Code from Coverage

### Why Exclude

- Compiler-generated code
- Platform-specific code
- Unreachable code
- Generated code

### How to Exclude

Use `[ExcludeFromCodeCoverage]` attribute:

```csharp
[ExcludeFromCodeCoverage]
public class AutoGeneratedCode
{
    // Code here won't count against coverage
}
```

Or exclude in `.runsettings`:

```xml
<Exclude>[MagickCrop.Tests]*,[*.Generated]*</Exclude>
```

## Troubleshooting Coverage

### Coverage Not Being Collected

1. Verify `.runsettings` is in test project directory
2. Check Coverlet package is installed
3. Ensure test project targets `net10.0-windows`
4. Run: `dotnet test --settings:.runsettings`

### False Coverage Gaps

- IntelliSense may show coverage incorrectly
- Rebuild solution and rerun tests
- Clear `bin/obj` folders

### Slow Coverage Generation

- Coverage collection adds ~20-30% overhead
- Use only when needed for reporting
- Run local tests without coverage for development

## Best Practices

1. **Maintain high coverage**: Aim for 75%+ overall
2. **Focus on critical paths**: Don't chase 100% coverage
3. **Review coverage reports regularly**: Monthly reviews
4. **Test meaningful scenarios**: Not just line coverage
5. **Avoid coverage gaming**: Write real tests, not fake ones
6. **Monitor trends**: Use CI/CD reports to track changes

## References

- [Coverlet Documentation](https://github.com/coverlet-coverage/coverlet)
- [ReportGenerator](https://github.com/danielpalme/ReportGenerator)
- [OpenCover Format](https://github.com/OpenCover/opencover)

---

*Last Updated: January 2026*
*Current Framework: Coverlet 6.0.0, OpenCover format*
